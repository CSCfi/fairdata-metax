version: "3.8"

services:
  metax:
    image: fairdata-docker.artifactory.ci.csc.fi/fairdata-metax-web
    ports:
      - 8008:8008
      - 8000:8000
    volumes:
      - ./src:/code
    environment:
      DEBUG: 'true'
      METAX_DATABASE: 'metax_db_test'
      METAX_DATABASE_PASSWORD: 'YMDLekQMqrVKcs3'
      METAX_DATABASE_USER: 'metax_test'
      REDIS_HOST: redis
      RABBIT_MQ_HOSTS: rabbitmq
      ELASTIC_SEARCH_HOSTS: elasticsearch
      METAX_DATABASE_HOST: db
    configs:
      - source: metax-web-config
        target: '/code/metax_api/settings/.env'
  redis:
    image: redis
    volumes:
      - metax-redis:/data
  db:
    image: postgres:9
    environment:
      POSTGRES_USER: 'metax_test'
      POSTGRES_PASSWORD: 'YMDLekQMqrVKcs3'
      POSTGRES_DB: 'metax_db_test'
    volumes:
      - metax-postgres:/var/lib/postgresql96/data
  elasticsearch:
    image: elasticsearch:7.9.2
    environment:
      discovery.type: 'single-node'
    volumes:
      - metax-es:/usr/share/elasticsearch/data
  rabbitmq:
    image: rabbitmq:3-management
    volumes:
      - metax-rabbitmq:/var/lib/rabbitmq
  nginx:
    image: nginx:latest
    configs:
      - source: metax-nginx-config
        target: '/etc/nginx/nginx.conf'
      - source: fairdata-ssl-certificate
        target: '/etc/nginx/ssl_certs/fd-dev.csc.fi.crt.pem'
      - source: fairdata-ssl-certificate-key
        target: '/etc/nginx/ssl_certs/fd-dev.csc.fi.key.pem'
    ports:
      - 4433:443

configs:
  metax-web-config:
    external: True
  fairdata-ssl-certificate:
    external: True
  fairdata-ssl-certificate-key:
    external: True
  metax-nginx-config:
    external: True
  metax-nginx-elastic-headers-config:
    external: True
  metax-nginx-shared-headers-config:
    external: True
  metax-nginx-api-response-headers-config:
    external: True
  metax-nginx-static-file-headers-config:
    external: True

volumes:
  metax-rabbitmq:
  metax-es:
  metax-postgres:
  metax-redis:



