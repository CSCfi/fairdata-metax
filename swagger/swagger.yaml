swagger: '2.0'
info:
  title: METAX REST API
  version: v1
host: __METAX_ENV_DOMAIN__
schemes:
  - https
basePath: /rest/v1/
produces:
  - application/json

paths:

# File Storage API
  /rest/filestorages:
    get:
      summary: List File Storages
      parameters:
        - name: ordering
          in: query
          description: specify ordering of results by fields. accepts a list of field names separated by a comma. ordering can be reversed by prefixing field name with a '-' char.
          required: false
          type: string
      responses:
        "200":
          description: return list of file storages
      tags:
        - File Storage API
    post:
      summary: Create File Storage metadata
      parameters:
        - $ref: "#/parameters/dryrun"
      consumes:
        - application/json
      responses:
        '201':
          description: new file storage created, returns created object
        '400':
          description: parameters contained errors, response includes details
        '401':
          description: Unauthorized
      tags:
        - File Storage API
  /rest/filestorages/{PID}:
    get:
      summary: Get File Storage metadata
      parameters:
        - name: PID
          in: path
          description: identifier of file storage
          required: true
          type: string
      responses:
        '200':
          description: return file storage metadata
        '404':
          description: not found
      tags:
        - File Storage API
    put:
      summary: Replace File Storage metadata
      parameters:
        - name: PID
          in: path
          description: identifier of file storage
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation. modified content returned
        '400':
          description: parameters contained errors, response includes details
        '401':
          description: Unauthorized. Reserved for admins only
      tags:
        - File Storage API
    patch:
      summary: Partially replace File Storage metadata
      parameters:
        - name: PID
          in: path
          description: identifier of file storage
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation. modified content returned
        '400':
          description: parameters contained errors, response includes details
        '401':
          description: Unauthorized. Reserved for admins only
      tags:
        - File Storage API
    delete:
      summary: Delete File Storage metadata
      parameters:
        - name: PID
          in: path
          description: identifier of file storage
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '204':
          description: successful operation
        '401':
          description: Unauthorized. Reserved for admins only
        '404':
          description: not found
      tags:
        - File Storage API

# File API
  /rest/files:
    get:
      summary: get list of files
      parameters:
        - name: project_identifier
          in: query
          description: filter files by project
          required: false
          type: string
        - name: offset
          in: query
          description: offset for paging
          required: false
          type: integer
        - name: limit
          in: query
          description: limit for paging
          required: false
          type: integer
          default: 10
        - name: ordering
          in: query
          description: specify ordering of results by fields. accepts a list of field names separated by a comma. ordering can be reversed by prefixing field name with a '-' char.
          required: false
          type: string
      responses:
        "200":
          description: successful operation, return list of files
          schema:
            $ref: '#/definitions/FileList'
      tags:
        - File API
    post:
      summary: create new file metadata
      consumes:
        - application/json
      parameters:
      - in: "body"
        name: "body"
        description: "Object or a list of objects to create."
        required: true
        schema:
          $ref: '#/definitions/File'
      - $ref: "#/parameters/dryrun"
      responses:
        '201':
          description: Returns the created object, or if a list was given, a list of objects and errors.
        '400':
          description: parameters contained errors, response includes details.
      tags:
        - File API
    put:
      summary: bulk update
      consumes:
        - application/json
      parameters:
      - in: "body"
        name: "body"
        description: "A list of objects to update."
        required: true
        schema:
          $ref: '#/definitions/FileList'
      - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: Successful operation. Return values include a list of errors, if any.
        '400':
          description: All updates failed. A list of errors is returned.
      tags:
        - File API
    patch:
      summary: bulk update partial
      description: |
        The payload must include a field that can be used to identify the resource being updated. Acceptable identifier fields are: <b>id, identifier</b>
      consumes:
        - application/json
      parameters:
        - in: "body"
          name: "body"
          description: "A list of (partial) objects to update."
          required: true
          schema:
            $ref: '#/definitions/FileList'
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: Some or all objects were updated. Return values contain list of full updated objects, and may include a list of errors.
        '400':
          description: All updates failed. A list of errors is returned.
      tags:
        - File API
    delete:
      summary: bulk delete
      description: Mark files as deleted en masse.
      consumes:
        - application/json
      parameters:
        - in: "body"
          name: "body"
          description: A list of ids, or a list of identifiers.
          required: true
          schema:
            $ref: '#/definitions/StringList'
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: |
            Successful operation. At least some requested files were marked deleted. If some of the provided
            identifiers were not found, those are ignored. Returns count of deleted files in json body.
        '400':
          description: All updates failed. A list of errors is returned.
        '404':
          description: None of the provided identifiers were found.
      tags:
        - File API
  /rest/files/{PID}:
    get:
      summary: get file metadata
      parameters:
        - name: PID
          in: path
          description: Persistent ID of file OR the internal pk
          required: true
          type: string
      responses:
        '200':
          description: return file metadata
          schema:
            $ref: '#/definitions/File'
        '404':
          description: not found
      tags:
        - File API
    put:
      summary: replace file metadata
      parameters:
        - name: PID
          in: path
          description: Persistent ID of file OR the internal pk
          required: true
          type: string
        - name: "body"
          in: "body"
          description: "Object to update the resource with"
          required: true
          schema:
            $ref: '#/definitions/File'
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation. modified content returned
        '400':
          description: parameters contained errors, response includes details
        '404':
          description: object not found
      tags:
        - File API
    patch:
      summary: replace part of file metadata
      parameters:
        - name: PID
          in: path
          description: Persistent ID of file OR the internal pk
          required: true
          type: string
        - name: "body"
          in: "body"
          description: "(Partial) Object to update the resource with"
          required: true
          schema:
            $ref: '#/definitions/File'
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation, full content returned
          schema:
            $ref: '#/definitions/File'
        '400':
          description: parameters contained errors, response includes details
        '404':
          description: object not found
      tags:
        - File API
    delete:
      summary: delete a file
      parameters:
        - name: PID
          in: path
          description: Persistent ID of file OR the internal pk
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '204':
          description: successful operation, no content returned
        '404':
          description: object not found
      tags:
        - File API
  /rest/files/{PID}/XML:
    get:
      summary: get XML metadata from file
      produces:
        - application/xml
        - application/json
      parameters:
        - name: PID
          in: path
          description: Persistent ID of file OR the internal pk
          required: true
          type: string
        - name: namespace
          in: query
          description: Namespace of the schema. If omitted, returns a list of xml metadata namespaces associated with the file.
          type: string
      responses:
        '200':
          description: single xml metadata (application/xml), or a list of namespaces (application/json)
        '404':
          description: file not found
      tags:
        - File API
    post:
      summary: create new XML metadata
      consumes:
        - application/xml
      produces:
        - application/xml
        - application/json
      parameters:
        - name: PID
          in: path
          description: persistent ID of file OR the internal pk
          required: true
          type: string
        - name: namespace
          in: query
          description: namespace of the schema. If a xml metadata already existed with given namespace, an error is returned
          required: true
          type: string
        - name: body
          in: body
          description: The XML to create.
          required: true
        - $ref: "#/parameters/dryrun"
      responses:
        '201':
          description: return created XML
        '400':
          description: parameters contained errors, response includes details (application/json)
      tags:
        - File API
    put:
      summary: update XML metadata
      consumes:
        - application/xml
      parameters:
        - name: PID
          in: path
          description: persistent ID of file OR the internal pk
          required: true
          type: string
        - name: namespace
          in: query
          description: namespace of the schema
          required: true
          type: string
        - name: body
          in: body
          description: "The XML to update"
          required: true
        - $ref: "#/parameters/dryrun"
      responses:
        '204':
          description: XML saved
        '400':
          description: parameters contained errors, response includes details
        '404':
          description: file or namespace does not exist
      tags:
        - File API
    delete:
      summary: delete XML metadata
      parameters:
        - name: PID
          in: path
          description: persistent ID of file OR the internal pk
          required: true
          type: string
        - name: namespace
          in: query
          description: namespace of the schema
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '204':
          description: XML is deleted
        '400':
          description: parameters contained errors, response includes details
        '404':
          description: file or namespace does not exist
      tags:
        - File API
  /rest/files/datasets:
    post:
      summary: get datasets where files belong to
      description: |
        Note&#58; The method is invoked using POST, because there are limits to length of query
        parameters in GET. Also, some clients forcibly shove parameters in body in GET
        requests to query parameters, so using POST instead is more guaranteed to work.
      produces:
        - application/json
      parameters:
        - name: body
          in: body
          description: a list of file id's (integers) or identifiers (strings).
          required: true
          schema:
            $ref: '#/definitions/StringList'
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: a list of preferred_identifiers. if the files were not found to belong to any datasets, an empty list is returned
        '404':
          description: files given in the list not found
      tags:
        - File API
  /rest/files/restore:
    post:
      summary: restore removed files back to "not removed" state.
      description: |
        note&#58; does not restore possible deprecated datasets (due to files having been removed) to back to non-deprecated state!
      produces:
        - application/json
      parameters:
        - name: body
          in: body
          description: a list of file identifiers of files to restore.
          required: true
          schema:
            $ref: '#/definitions/StringList'
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: numbers of files restored.
        '400':
          description: request ended in an error, response contains details.
      tags:
        - File API
  /rest/directories/{PID}:
    get:
      summary: get details of a directory
      description: Does not contain the directory's files and sub-directories. For that, use /rest/directories/{PID}/files
      parameters:
        - name: PID
          in: path
          description: Persistent ID of the resource OR the internal pk
          required: true
          type: string
      responses:
        '200':
          description: return directory details
          schema:
            $ref: '#/definitions/Directory'
        '404':
          description: not found
      tags:
        - File API
  /rest/directories/{PID}/files:
    get:
      summary: get list of files and directories contained by a directory
      parameters:
        - name: PID
          in: path
          description: persistent ID of the directory OR the internal pk
          required: true
          type: string
        - name: recursive
          in: query
          description: |
            return a flat list of file objects contained by the target directory and its sub-directories.
            if directories_only=true is also specified, returns a hierarchial directory tree instead, of x depth.
          required: false
          type: boolean
        - name: depth
          in: query
          description: max depth of recursion. value must be an integer > 0, or *. default value is 1.
          required: false
          type: string
        - name: directories_only
          in: query
          description: |
            omit files entirely from the returned results. use together with recursive=true and depth=x
            to get a directory tree.
          required: false
          type: boolean
        - name: include_parent
          in: query
          description: |
            includes the 'parent directory' of the contents being fetched in the results also. example&#58;
            GET /rest/directories/3/files?include_parent=true also includes data about directory id: 3 in the results.
            otherwise, one would query for its data separately by GET /rest/directories/3.
          required: false
          type: boolean
        - name: cr_identifier
          in: query
          description: identifier of a catalog record. browse only files that have been selected for that record.
          required: false
          type: string
        - name: file_fields
          in: query
          description: Comma-separated list of field names to retrieve for files
          required: false
          type: string
        - name: directory_fields
          in: query
          description: Comma-separated list of field names to retrieve for directories
          required: false
          type: string
      responses:
        '200':
          description: |
            returns a dict like { 'directories'&#58; [], 'files'&#58; [] }, where the lists contain directory and file objects.
            note&#58; if parameter 'recursive' is used, return value is a flat list of file objects instead.
        '404':
          description: directory not found
      tags:
        - File API
  /rest/directories/files:
    get:
      summary: get list of files and directories contained by a directory, queried by dir path and project
      description: |
        functions the same as /rest/directories/pid, except queried by dir path and project identifier, instead of directly by directory identifier.
      parameters:
        - name: path
          in: path
          description: path of the directory to browse
          required: true
          type: string
        - name: project
          in: query
          description: project_identifier of the project to browse from
          required: true
          type: string
        - name: recursive
          in: query
          description: |
            return a flat list of file objects contained by the target directory and its sub-directories.
            if directories_only=true is also specified, returns a hierarchial directory tree instead, of x depth.
          required: false
          type: boolean
        - name: depth
          in: query
          description: max depth of recursion. value must be an integer > 0, or *. default value is 1.
          required: false
          type: string
        - name: directories_only
          in: query
          description: |
            omit files entirely from the returned results. use together with recursive=true and depth=x
            to get a directory tree.
          required: false
          type: boolean
        - name: include_parent
          in: query
          description: |
            includes the 'parent directory' of the contents being fetched in the results also. example&#58;
            GET /rest/directories/3/files?include_parent=true also includes data about directory id: 3 in the results.
            otherwise, one would query for its data separately by GET /rest/directories/3.
          required: false
          type: boolean
        - name: preferred_identifier
          in: query
          description: preferred_identifier of a dataset. browse only files that have been selected for that record.
          required: false
          type: string
      responses:
        '200':
          description: |
            returns a dict like { 'directories'&#58; [], 'files'&#58; [] }, where the lists contain directory and file objects.
            note&#58; if parameter 'recursive' is used, return value is a flat list of file objects instead.
        '404':
          description: directory not found
      tags:
        - File API
  /rest/directories/root:
    get:
      summary: return root directory for a project, and its files and directories
      description: Useful when starting to browse files for a project, when individual root-level directory identifier is not yet known.
      parameters:
        - name: project
          in: query
          description: project_identifier of the project for which to find root directory
          required: true
          type: string
      responses:
        '200':
          description: |
            returns the root directory for the requested project.
            returned object additionally contains fields 'directories' and 'files', which contain the child directory and file objects of the root directory, similar to what API /directories/{PID}/files does.
        '400':
          description: bad parameters, details in body
        '404':
          description: directory not found
      tags:
        - File API



# Data Catalog API
  /rest/datacatalogs:
    get:
      summary: "list of data catalogs"
      parameters:
        - name: ordering
          in: query
          description: specify ordering of results by fields. accepts a list of field names separated by a comma. ordering can be reversed by prefixing field name with a '-' char.
          required: false
          type: string
      responses:
        "200":
          description: return list of file data catalogs
      tags:
        - Data Catalog API
    post:
      summary: create new data catalog
      consumes:
        - application/json
      parameters:
        - in: "body"
          name: "body"
          description: "Object or a list of objects to create."
          required: true
          schema:
            $ref: '#/definitions/DataCatalog'
        - $ref: "#/parameters/dryrun"
      responses:
        '201':
          description: new data catalog created
          schema:
            $ref: '#/definitions/DataCatalog'
        '401':
          description: Unauthorized. Reserved for admins only
      tags:
        - Data Catalog API
  /rest/datacatalogs/{PID}:
    get:
      summary: get data catalog metadata
      parameters:
        - name: PID
          in: path
          description: Persistent ID of the resource OR the internal pk
          required: true
          type: string
      responses:
        '200':
          description: return data catalog metadata
          schema:
            $ref: '#/definitions/DataCatalog'
        '404':
          description: not found
      tags:
        - Data Catalog API
    put:
      summary: replace data catalog metadata
      description: |
        # catalog_json read-only fields
        - identifier
      parameters:
        - name: PID
          in: path
          description: Persistent ID of the resource OR the internal pk
          required: true
          type: string
        - in: "body"
          name: "body"
          description: "Object to update the resource with"
          required: true
          schema:
            $ref: '#/definitions/DataCatalog'
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation. modified content returned
        '400':
          description: parameters contained errors, response includes details
        '401':
          description: Unauthorized. Reserved for admins only
      tags:
        - Data Catalog API
    patch:
      summary: replace part of catalog metadata
      description: |
        # catalog_json read-only fields
        - identifier
      parameters:
        - in: "body"
          name: "body"
          description: "(Partial) Object to update the resource with"
          required: true
          schema:
            $ref: '#/definitions/DataCatalog'
        - name: PID
          in: path
          description: Persistent ID of the resource OR the internal pk
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation, full content returned
          schema:
            $ref: '#/definitions/DataCatalog'
        '400':
          description: parameters contained errors, response includes details
      tags:
        - Data Catalog API






# Dataset API
  /rest/datasets:
    # some of the parameters and returned fields are for TPAS usage only
    get:
      summary: "list datasets"
      parameters:
        - name: latest
          in: query
          description: only return latest versions
          required: false
          type: boolean
        - name: owner_id
          in: query
          description: id of the person who owns the record in metax
          required: false
          type: string
        - name: user_created
          in: query
          description: id of the person who created the record in metax
          required: false
          type: string
        - name: curator
          in: query
          description: curator identifier (field research_dataset-> curator-> identifier)
          required: false
          type: string
        - name: preferred_identifier
          in: query
          description: |
            Use given preferred_identifier as filter. Returns a best guess of the record (always a single record!), by
            looking from Fairdata catalogs first, then from harvested catalogs. If the value of preferred_identifier
            contains special characters such as ampersands, the value has to be urlencoded.
          required: false
          type: string
        - name: state
          in: query
          description: TPAS state (field preservation_state). multiple states using OR-logic are queriable in the same request, e.g. state=5,6. see valid values from http://iow.csc.fi/model/mrd/CatalogRecord/ field preservation_state
          required: false
          type: string
        - name: metadata_owner_org
          in: query
          description: Filter by dataset field metadata_owner_org
          required: false
          type: string
        - name: metadata_provider_user
          in: query
          description: Filter by dataset field metadata_provider_user
          required: false
          type: string
        - name: contract_org_identifier
          in: query
          description: Filter by dataset contract.contract_json.organization.organization_identifier. Restricted to permitted users.
          required: false
          type: string
        - name: pas_filter
          in: query
          description: A specific filter that targets the following fields; research_dataset['title'], research_dataset['curator'][n]['name'], contract['contract_json']['title']. Restricted to permitted users.
          required: false
          type: string
        - name: editor
          in: query
          description: identifier of the editor used to modify the record, i.e. qvain.
          type: string
        - name: data_catalog
          in: query
          description: Filter by data catalog identifier
          type: string
        - name: offset
          in: query
          description: offset for paging
          required: false
          type: integer
        - name: limit
          in: query
          description: limit for paging
          required: false
          type: integer
          default: 10
        - name: ordering
          in: query
          description: specify ordering of results by fields. accepts a list of field names separated by a comma. ordering can be reversed by prefixing field name with a '-' char.
          required: false
          type: string
      responses:
        "200":
          description: successful operation, returns a list of datasets containing full dataset objects including their data catalog and contract information. when using query parameters, search result can be an empty list.
          schema:
            $ref: '#/definitions/CatalogRecord'
      tags:
        - Dataset API
    post:
      summary: create new dataset metadata
      description: |
        # research_dataset identifiers
        The fields <b>metadata_version_identifier</b> and <b>preferred_identifier</b> are generally always generated server-side. <b>Exception</b>: In harvested catalogs, preferred_identifier value can be provided by the user.
        # research_dataset read-only fields
        - metadata_version_identifier
        - preferred_identifier (except harvested catalogs)
        - total_files_byte_size (generated from files in the db according to files and directories listed in the dataset metadata)
        - total_remote_resources_byte_size (generated from entries in remote_resources)
      consumes:
        - application/json
      parameters:
        - in: "body"
          name: "body"
          description: "Object or a list of objects to create."
          required: true
          schema:
            $ref: '#/definitions/CatalogRecord'
        - $ref: "#/parameters/dryrun"
      responses:
        '201':
          description: Returns the created object, or if a list was given, a list of objects and errors.
        '400':
          description: parameters contained errors, response includes details.
      tags:
        - Dataset API
    put:
      summary: bulk update
      consumes:
        - application/json
      parameters:
        - in: "body"
          name: "body"
          description: "A list of objects to update."
          required: true
          schema:
            $ref: '#/definitions/CatalogRecordList'
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: Sucessful operation. Return values include a list of errors, if any.
        '400':
          description: All updates failed. A list of errors is returned.
      tags:
        - Dataset API
    patch:
      summary: bulk update partial
      description: |
        The payload must include a field that can be used to identify the resource being updated. Acceptable identifier fields are: <b>id, identifier</b>
      consumes:
        - application/json
      parameters:
        - in: "body"
          name: "body"
          description: "A list of (partial) objects to update."
          required: true
          schema:
            $ref: '#/definitions/CatalogRecordList'
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: Some or all objects were updated. Return values contain list of full updated objects, and may include a list of errors.
        '400':
          description: All updates failed. A list of errors is returned.
      tags:
        - Dataset API
  /rest/datasets/identifiers:
    get:
      summary: "list all dataset identifiers"
      parameters:
        - name: latest
          in: query
          description: only return latest versions
          required: false
          type: boolean
        - name: owner_id
          in: query
          description: id of the person who owns the record in metax
          required: false
          type: string
        - name: user_created
          in: query
          description: id of the person who created the record in metax
          required: false
          type: string
        - name: curator
          in: query
          description: curator identifier (field research_dataset-> curator-> identifier)
          required: false
          type: string
        - name: state
          in: query
          description: TPAS state (field preservation_state). multiple states using OR-logic are queriable in the same request, e.g. state=5,6. see valid values from http://iow.csc.fi/model/mrd/CatalogRecord/ field preservation_state
          required: false
          type: string
      responses:
        "200":
          description: successful operation, returns a list of all dataset metadata version identifiers.
      tags:
        - Dataset API
  /rest/datasets/unique_preferred_identifiers:
    get:
      summary: "list all unique dataset preferred identifiers"
      parameters:
        - name: latest
          in: query
          description: only return latest dataset versions
          required: false
          type: boolean
        - name: owner_id
          in: query
          description: id of the person who owns the record in metax
          required: false
          type: string
        - name: user_created
          in: query
          description: id of the person who created the record in metax
          required: false
          type: string
        - name: curator
          in: query
          description: curator identifier (field research_dataset-> curator-> identifier)
          required: false
          type: string
        - name: state
          in: query
          description: TPAS state (field preservation_state). multiple states using OR-logic are queriable in the same request, e.g. state=5,6. see valid values from http://iow.csc.fi/model/mrd/CatalogRecord/ field preservation_state
          required: false
          type: string
      responses:
        "200":
          description: successful operation, returns a list of all unique dataset preferred identifiers.
      tags:
        - Dataset API
  /rest/datasets/{PID}:
    get:
      summary: get dataset metadata
      parameters:
        - name: PID
          in: path
          description: Persistent ID of dataset OR the internal pk
          required: true
          type: string
        - name: dataset_format
          in: query
          description: Name of the format the dataset should be returned in. <b>Note:</b> Using this parameter causes the api to return only the field research_dataset, transformed to the requested format.
          required: false
          type: string
        - name: file_details
          in: query
          description: |
            Populate individual research_dataset.files and directories objects with their corresponding db object details.
            The details can be found behind the appended key 'details' that is placed into each file and directory in the dataset.
            Additionally total byte size and total file counts are calculated for directories, and are placed into fields
            byte_size and file_count in each directory's details as extra information.
          required: false
          type: boolean
        - name: file_fields
          in: query
          description: Comma-separated list of field names to retrieve for file details, when details are requested (query param file_details=true is passed)
          required: false
          type: string
        - name: directory_fields
          in: query
          description: Comma-separated list of field names to retrieve for directory details, when details are requested (query param file_details=true is passed)
          required: false
          type: string
        - name: preferred_identifier
          in: query
          description: |
            Return a hit only if the given PID is a preferred identifier.
          required: false
          type: boolean
      responses:
        '200':
          description: return dataset metadata
          schema:
            $ref: '#/definitions/CatalogRecord'
        '404':
          description: not found
      tags:
        - Dataset API
    put:
      summary: replace dataset metadata
      description: |
        # research_dataset read-only fields
        - metadata_version_identifier
        - preferred_identifier (except harvested catalogs)
        - total_files_byte_size (generated from files in the db according to files and directories listed in the dataset metadata)
        - total_remote_resources_byte_size (generated from entries in remote_resources)
      parameters:
        - in: "body"
          name: "body"
          description: "Object to update the resource with"
          required: true
          schema:
            $ref: '#/definitions/CatalogRecord'
        - name: PID
          in: path
          description: Persistent ID of dataset OR the internal pk
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation. modified content returned
        '400':
          description: parameters contained errors, response includes details
      tags:
        - Dataset API
    patch:
      summary: replace part of dataset metadata
      description: |
        # research_dataset read-only fields
        - metadata_version_identifier
        - preferred_identifier (except harvested catalogs)
        - total_files_byte_size (generated from files in the db according to files and directories listed in the dataset metadata)
        - total_remote_resources_byte_size (generated from entries in remote_resources)
      parameters:
        - in: "body"
          name: "body"
          description: "(Partial) Object to update the resource with"
          required: true
          schema:
            $ref: '#/definitions/CatalogRecord'
        - name: PID
          in: path
          description: Persistent ID of dataset OR the internal pk
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation, full content returned
          schema:
            $ref: '#/definitions/CatalogRecord'
        '400':
          description: parameters contained errors, response includes details
      tags:
        - Dataset API
  /rest/datasets/{PID}/files:
    get:
      summary: get list of files in a dataset
      parameters:
        - name: PID
          in: path
          description: Persistent ID of dataset OR the internal pk
          required: true
          type: string
        - name: file_fields
          in: query
          description: Comma-separated list of field names to retrieve for files
          required: false
          type: string
        - name: removed_files
          in: query
          description: return only deleted files
          required: false
          type: boolean
      responses:
        '200':
          description: successful operation, return list of full files metadata
      tags:
        - Dataset API
  /rest/datasets/{PID}/metadata_versions:
    get:
      summary: "list old research_dataset entries of a record"
      parameters:
        - name: PID
          in: path
          description: Persistent ID of dataset OR the internal pk
          required: true
          type: string
      responses:
        "200":
          description: successful operation, return a list of entries. may return an empty list.
          schema:
            $ref: '#/definitions/StringList'
      tags:
        - Dataset API
  /rest/datasets/{PID}/metadata_versions/{MVI}:
    get:
      summary: "get contents of a specific old research_dataset of a record."
      parameters:
        - name: PID
          in: path
          description: Persistent ID of dataset OR the internal pk
          required: true
          type: string
        - name: MVI
          in: path
          description: the metadata_version_identifier of the research_dataset
          required: true
          type: string
      responses:
        "200":
          description: successful operation, return a list of entries. may return an empty list.
        "404":
          description: resource not found.
      tags:
        - Dataset API

# Contract API
  /rest/contracts:
    get:
      summary: "list contracts"
      parameters:
        - name: organization
          in: query
          description: organization ID (field contract_json-> organization-> organization_identifier)
          required: false
          type: string
        - name: offset
          in: query
          description: offset for paging
          required: false
          type: integer
        - name: limit
          in: query
          description: limit for paging
          required: false
          type: integer
        - name: ordering
          in: query
          description: specify ordering of results by fields. accepts a list of field names separated by a comma. ordering can be reversed by prefixing field name with a '-' char.
          required: false
          type: string
      responses:
        "200":
          description: successful operation, return list of contracts
      tags:
        - Contract API
    post:
      summary: create new contract metadata
      parameters:
        - $ref: "#/parameters/dryrun"
      consumes:
        - application/json
      responses:
        '201':
          description: new contract metadata created, returns the created object, or if a list was given, a list of objects
        '400':
          description: parameters contained errors, response includes details
      tags:
        - Contract API
  /rest/contracts/{PID}:
    get:
      summary: get contract metadata
      parameters:
        - name: PID
          in: path
          description: Persistent ID of contract OR the internal pk
          required: true
          type: string
      responses:
        '200':
          description: return contract metadata
        '404':
          description: not found
      tags:
        - Contract API
    put:
      summary: replace contract metadata
      parameters:
        - name: PID
          in: path
          description: Persistent ID of contract OR the internal pk
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation. modified content returned
        '400':
          description: parameters contained errors, response includes details
      tags:
        - Contract API
    patch:
      summary: replace part of contract metadata
      parameters:
        - name: PID
          in: path
          description: Persistent ID of contract OR the internal pk
          required: true
          type: string
        - $ref: "#/parameters/dryrun"
      responses:
        '200':
          description: successful operation, full content returned
        '400':
          description: parameters contained errors, response includes details
      tags:
        - Contract API


# ApiErrors API
  /rest/apierrors:
    get:
      summary: "list errors produced during api requests"
      responses:
        '200':
          description: returns a list of error entries. may return an empty list.
      tags:
        - ApiErrors API
  /rest/apierrors/{identifier}:
    get:
      summary: get details of a single error entry
      parameters:
        - name: identifier
          in: path
          description: error_identifier of an error response
          required: true
          type: string
      responses:
        '200':
          description: return error details as a json object
        '404':
          description: not found
      tags:
        - ApiErrors API
    delete:
      summary: delete a single error entry
      parameters:
        - name: identifier
          in: path
          description: error_identifier of an error response
          required: true
          type: string
      responses:
        '204':
          description: entry deleted
        '404':
          description: not found
      tags:
        - ApiErrors API
  /rest/apierrors/flush:
    post:
      summary: "delete all error entries"
      responses:
        '200':
          description: all entries deleted. return a json object telling how many items were deleted.
      tags:
        - ApiErrors API


# Schema API
  /rest/schemas:
    get:
      summary: "list schemas"
      responses:
        '200':
          description: successful operation, return list of schema names
      tags:
        - Schema API
  /rest/schemas/{name}:
    get:
      summary: get schema content
      parameters:
        - name: name
          in: path
          description: name of the schema to be retrieved
          required: true
          type: string
      responses:
        '200':
          description: return JSON schema
        '404':
          description: not found
      tags:
        - Schema API


# RPC APIs
  /rpc/datasets/get_minimal_dataset_template:
    get:
      summary: Get minimal dataset template.
      description:  Get minimal dataset template that can be used to create datasets. Service and End Users have different kind of templates. The returned template can be used as-is when creating a dataset into Metax.
      parameters:
        - name: type
          in: query
          description: Type of dataset template to retrieve. Accepted values&#58; service, enduser.
          required: true
          type: string
      responses:
        '200':
          description: successful operation, return dataset template as json.
          schema:
            $ref: '#/definitions/CatalogRecord'
      tags:
        - Dataset RPC
  /rpc/datasets/set_preservation_identifier:
    post:
      summary: Assign a preservation identifier value for a catalog record and return it
      description: Usable only by tpas user. Works only for ida catalog records. If cr does not have a preservation_identifier, creates it and handles appropriate publishing of the identifier, finally returns it. If cr already has a preservation identifier, just returns it.
      parameters:
        - name: identifier
          in: query
          description: Catalog record identifier for which the pas_identifier is to be assigned.
          required: true
          type: string
      responses:
        '200':
          description: successful operation, return catalog record preservation identifier.
          schema:
            $ref: '#/definitions/CatalogRecord'
      tags:
        - Dataset RPC
  # /rpc/statistics/something:
  #   get:
  #     summary: Statistics api will be described here.
  #     responses:
  #       '200':
  #         description: successful operation.
  #     tags:
  #       - Statistics RPC
  /rpc/files/delete_project:
    delete:
      summary: Deletes given project from the database.
      description: Usable by ida, tpas and metax users. Marks all related files deleted, deprecates related datasets and removes all directories. Returns number of deleted files. Request is successful even when the project identifier is wrong, number of deleted files is then 0.
      parameters:
        - name: project_identifier
          in: query
          description: Project's identifier what needs to be removed.
          required: true
          type: string
      responses:
        '200':
          description: Successful operation, returns the number of deleted files.
        '400':
          description: Unsuccesful operation when project identifier is missing.
      tags:
        - File RPC
        
parameters:
  dryrun:
    name: dryrun
    in: query
    description: execute the operation normally, returning the same response as normally, but do not save anything to db, or publish anything to remote services.
    required: false
    type: boolean

definitions:
  CatalogRecord:
    $ref: 'https://__METAX_ENV_DOMAIN__/apischemas/catalogrecord.json#/definitions/CatalogRecord'
  DataCatalog:
    $ref: 'https://__METAX_ENV_DOMAIN__/apischemas/datacatalog.json#/definitions/Catalog'
  File:
    $ref: 'https://__METAX_ENV_DOMAIN__/apischemas/file.json#/definitions/File'
  Directory:
    $ref: 'https://__METAX_ENV_DOMAIN__/apischemas/file.json#/definitions/Directory'
  StringList:
    type: array
    items:
      type: string
      example: "value"
  CatalogRecordList:
    type: array
    items:
      $ref: '#/definitions/CatalogRecord'
  FileList:
    type: array
    items:
      $ref: '#/definitions/File'
